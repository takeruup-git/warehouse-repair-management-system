{% extends "base.html" %}

{% block title %}定期自主検査記録表一覧 - 倉庫修繕費管理システム{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>定期自主検査記録表一覧</h1>
    <div>
        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="bi bi-file-earmark-excel"></i> フォーマット出力
        </button>
        <a href="{{ url_for('inspection.create_periodic_self') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 新規作成
        </a>
    </div>

<!-- フォーマット出力モーダル -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">定期自主検査フォーマット出力</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('inspection.export_periodic_self') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="start_date" class="form-label">開始日</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_date" class="form-label">終了日</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="management_number" class="form-label">管理番号（任意）</label>
                        <input type="text" class="form-control" id="management_number" name="management_number" placeholder="指定しない場合は全車両が対象">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> 出力
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<div class="card">
    <div class="card-body">
        <div class="mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="filterManagementNumber" placeholder="管理番号で検索">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="filterInspector" placeholder="点検者で検索">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterInspectionType">
                        <option value="">点検種別で絞り込み</option>
                        <option value="月次">月次</option>
                        <option value="年次">年次</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterRepairAction">
                        <option value="">修理対応で絞り込み</option>
                        <option value="要修理">要修理</option>
                        <option value="修理済">修理済</option>
                        <option value="経過観察">経過観察</option>
                    </select>
                </div>
            </div>
        </div>

        {% if inspections %}
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="inspectionTable">
                <thead>
                    <tr>
                        <th>点検日</th>
                        <th>管理番号</th>
                        <th>点検種別</th>
                        <th>モーター状態</th>
                        <th>タイヤ状態</th>
                        <th>フォーク状態</th>
                        <th>修理対応</th>
                        <th>点検者</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inspection in inspections %}
                    <tr>
                        <td>{{ inspection.inspection_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ inspection.management_number }}</td>
                        <td>{{ inspection.inspection_type }}</td>
                        <td>{{ inspection.motor_condition }}</td>
                        <td>{{ inspection.tire_condition }}</td>
                        <td>{{ inspection.fork_condition }}</td>
                        <td>{{ inspection.repair_action }}</td>
                        <td>{{ inspection.inspector }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="#" class="btn btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="#" class="btn btn-outline-secondary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            定期自主検査記録表のデータがありません。
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <p>
        <strong>注意:</strong> このページは開発中です。現在、詳細表示、編集、削除機能はまだ実装されていません。
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // フィルター要素の取得
    const filterManagementNumber = document.getElementById('filterManagementNumber');
    const filterInspector = document.getElementById('filterInspector');
    const filterInspectionType = document.getElementById('filterInspectionType');
    const filterRepairAction = document.getElementById('filterRepairAction');
    
    // テーブルの行を取得
    const table = document.getElementById('inspectionTable');
    if (!table) return; // テーブルが存在しない場合は処理を終了

    const rows = table.getElementsByTagName('tr');
    
    // フィルター関数
    function filterTable() {
        const managementNumberValue = filterManagementNumber.value.toLowerCase();
        const inspectorValue = filterInspector.value.toLowerCase();
        const inspectionTypeValue = filterInspectionType.value;
        const repairActionValue = filterRepairAction.value;
        
        // ヘッダー行をスキップして各行をチェック
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const managementNumber = row.cells[1].textContent.toLowerCase();
            const inspector = row.cells[7].textContent.toLowerCase();
            const inspectionType = row.cells[2].textContent;
            const repairAction = row.cells[6].textContent;
            
            // すべてのフィルター条件をチェック
            const matchManagementNumber = managementNumber.includes(managementNumberValue);
            const matchInspector = inspector.includes(inspectorValue);
            const matchInspectionType = !inspectionTypeValue || inspectionType === inspectionTypeValue;
            const matchRepairAction = !repairActionValue || repairAction === repairActionValue;
            
            // すべての条件に一致する場合のみ行を表示
            row.style.display = (matchManagementNumber && matchInspector && matchInspectionType && matchRepairAction) ? '' : 'none';
        }
    }
    
    // フィルターイベントリスナーの設定
    filterManagementNumber.addEventListener('input', filterTable);
    filterInspector.addEventListener('input', filterTable);
    filterInspectionType.addEventListener('change', filterTable);
    filterRepairAction.addEventListener('change', filterTable);

    // 日付入力の初期値を設定
    const today = new Date();
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    
    // 開始日を1ヶ月前に設定
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    startDate.value = lastMonth.toISOString().split('T')[0];
    
    // 終了日を今日に設定
    endDate.value = today.toISOString().split('T')[0];
    
    // 終了日の最小値を開始日に合わせる
    startDate.addEventListener('change', function() {
        endDate.min = startDate.value;
        if (endDate.value < startDate.value) {
            endDate.value = startDate.value;
        }
    });
    
    // 開始日の最大値を終了日に合わせる
    endDate.addEventListener('change', function() {
        startDate.max = endDate.value;
        if (startDate.value > endDate.value) {
            startDate.value = endDate.value;
        }
    });
});
</script>
{% endblock %}